# Apache Jena and Fuseki Playground

This repository serves as playground for checking out Apache Jena and Apache Fuseki.
The repository provides

* Dockerfiles for running an Apache Fuseki server
* Dockerfiles for Apache Jena RDF I/O (RIOT)
* Example data
* Command line examples and Java code showing how to use Apache Jena and how to interact with Apache Fuseki

## Setup

1. Clone this repository

2. Install Docker and Docker Compose

    ```
    # Install Docker Compose
    sudo apt-get update
    sudo apt-get install docker-compose-plugin
    docker compose version
    ```

3. Build Apache Fuseki Docker container

    ```
    cd docker/jena-fuseki-docker-4.9.0
    sudo docker compose build --build-arg JENA_VERSION=4.9.0
    # Test the build
    # Start Fuseki with an in-memory, updatable dataset at http://host:3030/ds
    sudo docker compose run --rm --service-ports fuseki --mem /ds
    ```

    For more information how to use the container, check:
    https://jena.apache.org/documentation/fuseki2/fuseki-docker.html

4. Install Java

    These commands work for Ubuntu 20.04

    ```
    sudo apt install openjdk-17-jre-headless
    export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64/
    java --version
    # Should return:
    # openjdk 17.0.8 2023-07-18
    ```

5. Install Apache Jena und Fuseki binaries

    Among others, this installs `riot` and `sparql`
    ```
    cd /opt
    wget https://dlcdn.apache.org/jena/binaries/apache-jena-fuseki-4.9.0.tar.gz
    wget https://dlcdn.apache.org/jena/binaries/apache-jena-4.9.0.tar.gz
    tar xzf apache-jena-fuseki-4.9.0.tar.gz
    tar xzf apache-jena-4.9.0.tar.gz
    ```

    Add the binaries to `PATH`:

    ```
    export PATH=/opt/apache-jena-4.9.0/bin/:/opt/apache-jena-fuseki-4.9.0/bin:$PATH
    ```

## Resources

* [Apache Jena Website](https://jena.apache.org/)
* [Apache Jena Tutorials and Documentation](https://jena.apache.org/getting_started/index.html)

## Working with RDF serialization formats

Jena provides tools for working with several RDF serialization formats:
* `riot`: parse, guessing the syntax from the file extension
* special parsers for particular languages (e.g. `turtle` for Turtle)
An overview can be found in the [Jena documentation](https://jena.apache.org/documentation/io/#command-line-tools)

### Validate

`riot` can be used to validate RDF serializations. It can be used to validate serializations generated by other programs, like the ProvToolbox examples at `example_datasets/ProvToolbox_playground`. The code that generated these examples is available in [this repository](https://github.com/fbartusch/ProvToolbox-playground).

```
riot --validate example_datasets/fmri_snakemake.jsonld
```

`riot` guesses the RDF format based on file extension.  If the extension isn't supported by `riot`, one can set the format via `--syntax=FORMAT`:

```
# riot expects .rdf or .owl for the RDF/XML Format, but we have .xml:
riot --syntax=RDF/XML --validate example_datasets/ProvToolbox_playground/fmri_provenance.xml
```

### Converting

`riot` can convert RDF serialization formats.
This command generates N-Triples from a Turtle file.

```
riot --output=N-Triples example_datasets/ProvToolbox_playground/fmri_provenance.ttl
```

### Inference

`riot` supports creation of inferred triples during the parsing process.
Output will contain the base data and triples inferred based on RDF subclass, subproperty, domain and range declarations.

We take the PROV onthology and our example data from ProvToolbox as example:
The onthology has to be in RDF/XML format. The filename has to end with `.rdf`.

```
wget http://www.w3.org/ns/prov.owl
mv prov.owl prov.rdf
```

Now we can use he onthology for inference:

```
riot --rdfs=example_datasets/onthologies/prov.rdf example_datasets/ProvToolbox_playground/fmri_provenance.ttl
```

These statements are present in `fmri_provenance.ttl`:

```
fmri:warp1 a prov:Entity ;
	rdfs:label "warp1" .
fmri:align-warp4 a prov:Activity ;
	rdfs:label "align_warp4" .
fmri:warp4 prov:wasGeneratedBy fmri:align-warp4 .
```

The PROV onthology defines the Property `wasGeneratedBy` as:

```
<owl:ObjectProperty rdf:about="http://www.w3.org/ns/prov#wasGeneratedBy">
        <rdfs:label>wasGeneratedBy</rdfs:label>
        <inverse>generated</inverse>
[...]
        <rdfs:subPropertyOf rdf:resource="http://www.w3.org/ns/prov#wasInfluencedBy"/>
[...]
    </owl:ObjectProperty>
```

The above `riot` command outputs the inferred triples:

```
<https://example.com/warp4> <http://www.w3.org/ns/prov#wasInfluencedBy> <https://example.com/align-warp4> .
```

`riot` infers subproperties. As `wasGeneratedBy` is a subproperty of `wasInfluenceBy`, this triple is inferred.
There are other inference engines that can infer more triples. You may notice that the reverse property `generated` is not inferred, because `riot` does not infer inverse properties.


## Working with Apache Fuseki

Load a TDB2 database, and expose, read-only, via Docker:

```
cd docker/jena-fuseki-docker-4.9.0
mkdir -p databases/DB2
sudo docker run \
  -it \
  -v "$(pwd)"/example_datasets:/input \
  -v "$(pwd)"/docker/jena-fuseki-docker-4.9.0/databases:/databases \
  jena:latest \
  tdb2.tdbloader --loc /databases/DB2 /input/ProvToolbox_playground/fmri_provenance.ttl

04:45:31 INFO  loader          :: Loader = LoaderPhased
04:45:31 INFO  loader          :: Start: /input/ProvToolbox_playground/fmri_provenance.ttl
04:45:31 INFO  loader          :: Finished: /input/ProvToolbox_playground/fmri_provenance.ttl: 141 tuples in 0.21s (Avg: 658)
04:45:31 INFO  loader          :: Finish - index SPO
04:45:31 INFO  loader          :: Start replay index SPO
04:45:31 INFO  loader          :: Index set:  SPO => SPO->POS, SPO->OSP
04:45:31 INFO  loader          :: Index set:  SPO => SPO->POS, SPO->OSP [141 items, 0.0 seconds]
04:45:31 INFO  loader          :: Finish - index OSP
04:45:31 INFO  loader          :: Finish - index POS
```

Start the Fuseki server using and expose the database read-only:

```
cd docker/jena-fuseki-docker-4.9.0
# Without chaning permissions fuseki won't start. This is ugly, but in the end we just want to test things ...
sudo chmod -R 777 databases/

#sudo docker compose run --rm --name MyServer --service-ports fuseki --loc databases/DB2 /ds
sudo docker compose up
[2023-12-06 05:31:28] INFO  Server          :: Apache Jena Fuseki 4.9.0
[2023-12-06 05:31:29] INFO  Server          :: Database: TDB2 dataset: location=databases/DB2
[2023-12-06 05:31:29] INFO  Server          :: Path = /ds
[2023-12-06 05:31:29] INFO  Server          ::   Memory: 2.0 GiB
[2023-12-06 05:31:29] INFO  Server          ::   Java:   17.0.9
[2023-12-06 05:31:29] INFO  Server          ::   OS:     Linux 5.15.0-89-generic amd64
[2023-12-06 05:31:29] INFO  Server          ::   PID:    1
[2023-12-06 05:31:29] INFO  Server          :: Start Fuseki (http=3030)
```

### Interact with the Fuseki server

#### Retrieve data

```
s-get http://localhost:3030/ds/data default
```

#### Make Queries

This return every stored triple:

```
s-query --service http://localhost:3030/ds/query 'SELECT * {?s ?p ?o}'
```

## SPARQL Queries on RDF

SPARQL queries can be performed from the command line:

```
# Example: https://jena.apache.org/tutorials/sparql_query1.html
sparql --data=vc-db-1.rdf --query=q1.rq

--------------------------------
| x                            |
================================
| <http://somewhere/JohnSmith> |
--------------------------------
```